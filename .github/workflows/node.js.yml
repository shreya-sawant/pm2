name: Node.js CI

on: [push, pull_request]

jobs:

  node-tests:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    strategy:
      matrix:
        node-version: [22.x]

    steps:
      - uses: actions/checkout@v3
      - name: Use Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v3
        with:
          node-version: ${{ matrix.node-version }}
          cache: 'npm'
      - name: Install Python
        run: sudo apt install python3
      - name: Install PHP CLI
        run: sudo apt install php-cli
      - name: Install Node.js dependencies
        run: npm install
      - name: Run end-to-end tests
        run: npm run test:e2e
      - name: Run unit tests
        run: npm run test:unit

  bun-tests:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      - name: Remove Node.js installed by setup-node action (if any)
        run: |
          if command -v node &> /dev/null; then
            sudo rm -rf "$(which node)"
          fi
          if command -v npm &> /dev/null; then
            sudo rm -rf "$(which npm)"
          fi

      - name: Setup Bun
        uses: oven-sh/setup-bun@v1
      - name: Install dependencies using Bun
        run: bun install
      - name: Run end-to-end tests with Bun
        run: bun run test:e2e
      - name: Run unit tests with Bun
        run: bun run test:unit

  node-tests-s390x:
    runs-on: ubuntu-latest
    timeout-minutes: 60

    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3
        with:
          platforms: all

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build and test on s390x
        run: |
          docker buildx build --platform linux/s390x --pull --load -t s390x-pm2 - <<EOF
          FROM ubuntu:22.04

          RUN apt-get update && apt-get install -y \
            curl wget xz-utils tar python3 php-cli git \
            && rm -rf /var/lib/apt/lists/*

          # Install Node.js for s390x manually
          RUN wget https://nodejs.org/dist/v17.5.0/node-v17.5.0-linux-s390x.tar.xz && \
              tar xf node-v17.5.0-linux-s390x.tar.xz && \
              mv node-v17.5.0-linux-s390x /opt/node && \
              ln -s /opt/node/bin/node /usr/bin/node && \
              ln -s /opt/node/bin/npm /usr/bin/npm

          WORKDIR /app
          COPY . .

          RUN npm install
          CMD ["npm", "run", "test:e2e"]
          EOF

          docker run --rm s390x-pm2

